rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isEnterprise() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'enterprise';
    }

    // --- USERS COLLECTION ---
    // Anyone can read basic profile info (needed for listings)
    // Only the user themselves can write/update their own profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Allow create (signup) - Enforce max initial balance of 100 to prevent fraud
      allow create: if isOwner(userId) && request.resource.data.walletBalance <= 100;
      // Allow update ONLY if NOT touching sensitive fields
      allow update: if isOwner(userId) 
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['walletBalance', 'pointsHistory', 'subscriptionTier', 'isLifetimeMember', 'retiredBalance', 'aiScanCount', 'rating']);
    }

    // --- FOOD LISTINGS ---
    // Public read
    // Create: Auth only
    // Update: Owner OR Taker claiming (changing status from 'available' to 'claim')
    match /listings/{listingId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.giverId == request.auth.uid || 
        (resource.data.status == 'available' && request.resource.data.status == 'claim') ||
        (resource.data.claimedBy == request.auth.uid && request.resource.data.status == 'available') // Allow unclaim
      );
      allow delete: if isAuthenticated() && resource.data.giverId == request.auth.uid;
    }

    // --- CHAT MESSAGES ---
    // Only participants (sender or receiver) can read/write
    match /chat_messages/{messageId} {
      allow read: if isAuthenticated() && (resource.data.senderId == request.auth.uid || resource.data.receiverId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
    }

    // --- TRADE OFFERS (B2B) ---
    // Enterprise can create
    // Targeted users can read
    match /trade_offers/{offerId} {
      allow read: if isAuthenticated() && (
        resource.data.enterpriseId == request.auth.uid || 
        resource.data.targetUserId == request.auth.uid
      );
      allow write: if isAuthenticated() && (
        isEnterprise() || 
        (resource.data.targetUserId == request.auth.uid && request.resource.data.status in ['accepted', 'rejected'])
      );
    }

    // --- B2B LISTINGS (Carbon Credits) ---
    match /b2b_listings/{listingId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isEnterprise();
    }
  }
}
